<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë‘ìŠ¤ì–´ ë°œìŒ ìŠ¤í”¼ë“œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ê²Œì„ ìƒíƒœ
        let gameState = 'start';
        let currentWord = null;
        let score = 0;
        let timeLeft = 120;
        let isListening = false;
        let feedback = '';
        let nickname = '';
        let leaderboard = [];
        let recognition = null;
        let timerInterval = null;

        // í”„ë‘ìŠ¤ì–´ ë‹¨ì–´
        const frenchWords = [
            { french: 'bonjour', korean: 'ì•ˆë…•í•˜ì„¸ìš”' },
            { french: 'merci', korean: 'ê°ì‚¬í•©ë‹ˆë‹¤' },
            { french: 'chat', korean: 'ê³ ì–‘ì´' },
            { french: 'chien', korean: 'ê°œ' },
            { french: 'maison', korean: 'ì§‘' },
            { french: 'eau', korean: 'ë¬¼' },
            { french: 'pain', korean: 'ë¹µ' },
            { french: 'livre', korean: 'ì±…' },
            { french: 'soleil', korean: 'íƒœì–‘' },
            { french: 'lune', korean: 'ë‹¬' },
            { french: 'fleur', korean: 'ê½ƒ' },
            { french: 'arbre', korean: 'ë‚˜ë¬´' },
            { french: 'ami', korean: 'ì¹œêµ¬' },
            { french: 'Ã©cole', korean: 'í•™êµ' },
            { french: 'rouge', korean: 'ë¹¨ê°•' },
            { french: 'bleu', korean: 'íŒŒë‘' },
            { french: 'vert', korean: 'ì´ˆë¡' },
            { french: 'noir', korean: 'ê²€ì •' },
            { french: 'blanc', korean: 'í•˜ì–‘' },
            { french: 'cafÃ©', korean: 'ì»¤í”¼' }
        ];

        // ë¦¬ë”ë³´ë“œ ë¡œë“œ
        function loadLeaderboard() {
            const saved = localStorage.getItem('frenchGameLeaderboard');
            if (saved) {
                leaderboard = JSON.parse(saved);
            }
        }

        // ì ìˆ˜ ì €ì¥
        function saveScore() {
            const newEntry = {
                nickname: nickname,
                score: score,
                date: new Date().toISOString()
            };
            
            leaderboard.push(newEntry);
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 28);
            
            localStorage.setItem('frenchGameLeaderboard', JSON.stringify(leaderboard));
        }

        // ëœë¤ ë‹¨ì–´
        function getRandomWord() {
            const randomIndex = Math.floor(Math.random() * frenchWords.length);
            currentWord = frenchWords[randomIndex];
            feedback = '';
            render();
        }

        // ê²Œì„ ì‹œì‘
        function startGame() {
            const input = document.getElementById('nicknameInput');
            if (input) {
                nickname = input.value.trim();
            }
            
            if (!nickname) {
                alert('ë³„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            gameState = 'playing';
            score = 0;
            timeLeft = 120;
            feedback = '';
            getRandomWord();
            startTimer();
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    gameState = 'end';
                    saveScore();
                    render();
                } else {
                    render();
                }
            }, 1000);
        }

        // ë°œìŒ ë“£ê¸°
        function playSound() {
            if (currentWord && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const speak = () => {
                    const utterance = new SpeechSynthesisUtterance(currentWord.french);
                    const voices = window.speechSynthesis.getVoices();
                    const frenchVoice = voices.find(v => v.lang.startsWith('fr'));
                    
                    if (frenchVoice) utterance.voice = frenchVoice;
                    utterance.lang = 'fr-FR';
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    window.speechSynthesis.speak(utterance);
                };

                if (window.speechSynthesis.getVoices().length > 0) {
                    speak();
                } else {
                    window.speechSynthesis.onvoiceschanged = speak;
                }
            }
        }

        // ì •í™•ë„ ê³„ì‚°
        function calculateAccuracy(spoken, target) {
            spoken = spoken.toLowerCase().replace(/[^a-zÃ Ã¢Ã¤Ã¦Ã§Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Å“]/g, '');
            target = target.toLowerCase().replace(/[^a-zÃ Ã¢Ã¤Ã¦Ã§Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Å“]/g, '');
            
            if (spoken === target) return 100;
            
            const distance = levenshteinDistance(spoken, target);
            const maxLength = Math.max(spoken.length, target.length);
            const accuracy = Math.max(0, ((maxLength - distance) / maxLength) * 100);
            
            return Math.round(accuracy * 10) / 10;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
            for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // ìŒì„± ì¸ì‹
        function startListening() {
            try {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    feedback = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                    render();
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.lang = 'fr-FR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    feedback = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë°œìŒí•´ë³´ì„¸ìš”!';
                    render();
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const accuracy = calculateAccuracy(transcript, currentWord.french);
                    
                    feedback = 'ë°œìŒ: "' + transcript + '" | ì •í™•ë„: ' + accuracy + '%';
                    
                    if (accuracy >= 70) {
                        const points = accuracy / 10;
                        score = Math.round((score + points) * 10) / 10;
                        feedback = 'âœ… ì •í™•ë„: ' + accuracy + '% | +' + points.toFixed(1) + 'ì !';
                        render();
                        setTimeout(() => {
                            getRandomWord();
                        }, 1500);
                    } else {
                        feedback = 'âŒ ì •í™•ë„: ' + accuracy + '% | 70% ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”!';
                        render();
                    }
                };

                recognition.onerror = (event) => {
                    isListening = false;
                    if (event.error === 'no-speech') {
                        feedback = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                    } else if (event.error === 'not-allowed') {
                        feedback = 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    } else {
                        feedback = 'ì˜¤ë¥˜: ' + event.error + '. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                    }
                    render();
                };

                recognition.onend = () => {
                    isListening = false;
                    render();
                };

                recognition.start();
            } catch (error) {
                isListening = false;
                feedback = 'ìŒì„± ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜. Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                render();
            }
        }

        function stopListening() {
            if (recognition) {
                recognition.stop();
                isListening = false;
                render();
            }
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        }

        // ì•„ì´ì½˜ SVG
        function volumeIcon() {
            return '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';
        }

        function micIcon() {
            return '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>';
        }

        function micOffIcon() {
            return '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" x2="22" y1="2" y2="22"></line><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"></path><path d="M5 10v2a7 7 0 0 0 12 5"></path><path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"></path><path d="M9 9v3a3 3 0 0 0 5.12 2.12"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>';
        }

        // ë Œë”ë§
        function render() {
            const app = document.getElementById('app');
            
            if (gameState === 'start') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-12 text-center max-w-md w-full">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ì–´ ë°œìŒ</h1>
                            <h2 class="text-3xl font-bold text-purple-600 mb-6">ìŠ¤í”¼ë“œ ê²Œì„</h2>
                            <p class="text-gray-600 mb-8 text-lg">
                                2ë¶„ ë™ì•ˆ í”„ë‘ìŠ¤ì–´ ë‹¨ì–´ë¥¼<br>
                                ì •í™•í•˜ê²Œ ë°œìŒí•´ë³´ì„¸ìš”!<br>
                                <span class="text-sm mt-2 block">ì •í™•ë„ 70% ì´ìƒì´ë©´ ì ìˆ˜ íšë“!</span>
                            </p>
                            <div class="mb-8">
                                <input
                                    type="text"
                                    id="nicknameInput"
                                    placeholder="ë³„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                                    maxlength="15"
                                    class="w-full px-6 py-3 text-lg border-2 border-purple-300 rounded-full focus:outline-none focus:border-purple-500 text-center"
                                />
                            </div>
                            <button
                                onclick="startGame()"
                                class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-4 rounded-full text-xl font-bold hover:shadow-lg transform hover:scale-105 transition w-full"
                            >
                                ê²Œì„ ì‹œì‘
                            </button>
                        </div>
                    </div>
                `;
                
                const input = document.getElementById('nicknameInput');
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') startGame();
                    });
                }
            } else if (gameState === 'end') {
                const currentRank = leaderboard.findIndex(entry => 
                    entry.nickname === nickname && entry.score === score
                ) + 1;

                let leaderboardHTML = '';
                if (leaderboard.length === 0) {
                    leaderboardHTML = '<p class="text-gray-500 text-center py-8">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                } else {
                    leaderboard.forEach((entry, index) => {
                        const isCurrentUser = entry.nickname === nickname && entry.score === score && index === currentRank - 1;
                        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1) + 'ìœ„';
                        
                        leaderboardHTML += `
                            <div class="flex items-center justify-between p-4 rounded-xl ${isCurrentUser ? 'bg-gradient-to-r from-yellow-200 to-orange-200 border-2 border-yellow-400' : 'bg-gray-100'}">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl font-bold ${index < 3 ? 'text-yellow-500' : 'text-gray-600'}">${medal}</span>
                                    <span class="font-semibold text-gray-800 text-lg">${entry.nickname}</span>
                                </div>
                                <span class="text-2xl font-bold text-purple-600">${entry.score}ì </span>
                            </div>
                        `;
                    });
                }

                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center p-4">
                        <div class="max-w-4xl w-full grid md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <h1 class="text-4xl font-bold text-gray-800 mb-4">ê²Œì„ ë!</h1>
                                <div class="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-6 mb-4">
                                    <p class="text-white text-xl mb-1">í”Œë ˆì´ì–´</p>
                                    <p class="text-white text-3xl font-bold mb-3">${nickname}</p>
                                    <p class="text-white text-lg mb-1">ìµœì¢… ì ìˆ˜</p>
                                    <p class="text-white text-5xl font-bold">${score}ì </p>
                                    ${currentRank > 0 ? '<p class="text-white text-2xl font-bold mt-3">ğŸ† ' + currentRank + 'ë“±</p>' : ''}
                                </div>
                                <button
                                    onclick="gameState='start'; nickname=''; render();"
                                    class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-3 rounded-full text-lg font-bold hover:shadow-lg transform hover:scale-105 transition w-full"
                                >
                                    ì‹œì‘ í™”ë©´ìœ¼ë¡œ
                                </button>
                            </div>
                            <div class="bg-white rounded-2xl shadow-2xl p-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">ğŸ† ë¦¬ë”ë³´ë“œ TOP 28</h2>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${leaderboardHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-indigo-400 to-cyan-400 p-4">
                        <div class="max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-8 bg-white rounded-xl shadow-lg p-4">
                                <div class="flex items-center gap-6">
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">íƒ€ì´ë¨¸</p>
                                        <p class="text-3xl font-bold text-red-500">${formatTime(timeLeft)}</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">ì ìˆ˜</p>
                                        <p class="text-3xl font-bold text-green-500">${score}ì </p>
                                    </div>
                                </div>
                            </div>
                            ${currentWord ? `
                                <div class="bg-white rounded-3xl shadow-2xl p-12 text-center">
                                    <h2 class="text-6xl font-bold text-gray-800 mb-6">${currentWord.french}</h2>
                                    <p class="text-3xl text-gray-600 mb-8">${currentWord.korean}</p>
                                    <div class="flex justify-center gap-6 mb-8">
                                        <button
                                            onclick="playSound()"
                                            class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-full shadow-lg transform hover:scale-110 transition"
                                            title="ë°œìŒ ë“£ê¸°"
                                        >
                                            ${volumeIcon()}
                                        </button>
                                        <button
                                            onclick="${isListening ? 'stopListening()' : 'startListening()'}"
                                            class="${isListening ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white p-6 rounded-full shadow-lg transform hover:scale-110 transition"
                                            title="${isListening ? 'ë…¹ìŒ ì¤‘ì§€' : 'ë°œìŒí•˜ê¸°'}"
                                        >
                                            ${isListening ? micOffIcon() : micIcon()}
                                        </button>
                                    </div>
                                    ${feedback ? `
                                        <div class="bg-purple-100 border-2 border-purple-300 rounded-xl p-4">
                                            <p class="text-lg text-purple-800 font-semibold">${feedback}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        // ì´ˆê¸°í™”
        loadLeaderboard();
        render();
    </script>
</body>
</html>